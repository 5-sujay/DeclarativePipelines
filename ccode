  
pipeline {
    agent none
    stages {
       stage('gitinit') {
       agent {label "Agent C"}
            steps {
                sh '''
                 
                if [ ! -f .git ] && [ ! -d devtest ]
                then
                git init
                git clone https://github.com/deesnest/devtest
                fi
                  
                 '''
             }
        }
        stage('build1') {
        agent {label "Agent C"}
            steps {
            sh '''
                #git pull https://github.com/deesnest/devtest
                cd devtest
                pwd
                gcc -c main.c fact.c palin.c rev.c sum.c
                gcc -o ABC.exe main.o fact.o palin.o rev.o sum.o
                if [ ! -d cbuild ]
                then
                mkdir cbuild
                else
                path=$PWD
                cp $path/ABC.exe $path/cbuild
                echo "C project Build Successful"
                echo $PWD
                fi
                 '''
               
              }
        }
        stage('buildimage') {
        agent {label "kubeagent"}
            steps {
            sh '''
                     sudo docker pull ubuntu
  
                k=sudo docker run -v /home/ubuntu/workspace/cprojectnew/devtest/ABC.exe:/home/ubuntu/cbuild ubuntu:latest
                sudo docker commit $k build:v2
                sudo docker tag build:v2 deepatp/cbuild:1.0
                sudo docker push deepatp/cbuild:1.0
             '''
               
              }
        }
        stage('pods') {
            steps {
            sh '''  cp /home/ubuntu/kubernetes.pem $PWD
                    sudo chmod 400 kubernetes.pem
                    ssh -i "kubernetes.pem" ubuntu@ec2-65-0-179-142.ap-south-1.compute.amazonaws.com
                    sudo kubectl run cbuild --image=deepatp/test_repo:1.0
             '''
               
              }
        }
    }
}
